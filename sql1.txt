
-- Enable UUID extension (optional but good practice)
create extension if not exists "uuid-ossp";

-- 1. Table: requests
create table if not exists requests (
  "id" text primary key,
  "invoiceNumber" text,
  "clientName" text,
  "origin" text,
  "destination" text,
  "vehicleType" text,
  "distanceKm" float,
  "driverFee" float,
  "clientCharge" float,
  "status" text,
  "createdAt" text,
  "driverId" text,
  "scheduledFor" text,
  "activityType" text,
  "contactOnSite" text,
  "observations" text,
  "waypoints" jsonb
);

-- 2. Table: drivers
create table if not exists drivers (
  "id" text primary key,
  "name" text,
  "cpf" text,
  "address" text,
  "vehicleType" text,
  "phone" text,
  "createdAt" text,
  "plate" text,
  "model" text,
  "color" text
);

-- 3. Table: clients
create table if not exists clients (
  "id" text primary key,
  "name" text,
  "cnpj" text,
  "address" text,
  "costCenter" text,
  "contactName" text,
  "contactPhone" text,
  "contactEmail" text,
  "paymentDay" int,
  "createdAt" text
);

-- 4. Table: expenses
create table if not exists expenses (
  "id" text primary key,
  "driverId" text,
  "type" text,
  "amount" float,
  "date" text,
  "description" text
);

-- 5. Table: rates
create table if not exists rates (
  "type" text primary key,
  "label" text,
  "costPerKm" float,
  "chargePerKm" float,
  "baseFee" float
);

-- 6. Table: users
create table if not exists users (
  "id" text primary key,
  "username" text unique,
  "password" text, -- Plain text for demo, use hash in prod
  "role" text, -- ADMIN, OPERATIONAL, CLIENT
  "clientId" text, -- foreign key to clients if role is CLIENT
  "name" text,
  "mustChangePassword" boolean default false
);

-- 7. SAFELY ADD NEW COLUMNS (Migration Logic)
-- IMPORTANT: This block must run BEFORE inserts to ensure columns exist
do $$
begin
  -- Add 'scheduledFor' to requests
  if not exists (select 1 from information_schema.columns where table_name='requests' and column_name='scheduledFor') then
    alter table requests add column "scheduledFor" text;
  end if;

  -- Add 'activityType' to requests
  if not exists (select 1 from information_schema.columns where table_name='requests' and column_name='activityType') then
    alter table requests add column "activityType" text;
  end if;

  -- Add 'contactOnSite' to requests
  if not exists (select 1 from information_schema.columns where table_name='requests' and column_name='contactOnSite') then
    alter table requests add column "contactOnSite" text;
  end if;

  -- Add 'observations' to requests
  if not exists (select 1 from information_schema.columns where table_name='requests' and column_name='observations') then
    alter table requests add column "observations" text;
  end if;
  
  -- Add 'waypoints' to requests (JSONB for efficient storage of arrays)
  if not exists (select 1 from information_schema.columns where table_name='requests' and column_name='waypoints') then
    alter table requests add column "waypoints" jsonb;
  end if;
  
  -- Add 'mustChangePassword' to users
  if exists (select 1 from information_schema.tables where table_name='users') then
    if not exists (select 1 from information_schema.columns where table_name='users' and column_name='mustChangePassword') then
        alter table users add column "mustChangePassword" boolean default false;
    end if;
  end if;

  -- Add 'plate' to drivers
  if not exists (select 1 from information_schema.columns where table_name='drivers' and column_name='plate') then
    alter table drivers add column "plate" text;
  end if;

  -- Add 'model' to drivers
  if not exists (select 1 from information_schema.columns where table_name='drivers' and column_name='model') then
    alter table drivers add column "model" text;
  end if;

  -- Add 'color' to drivers
  if not exists (select 1 from information_schema.columns where table_name='drivers' and column_name='color') then
    alter table drivers add column "color" text;
  end if;
end
$$;

-- 8. Insert Default Rates (prevent empty config)
insert into rates ("type", "label", "costPerKm", "chargePerKm", "baseFee")
values 
  ('MOTO', 'Motoboy', 1.50, 2.50, 5.00),
  ('CARRO', 'Carro', 2.50, 4.00, 8.00),
  ('UTILITARIO', 'Utilitário', 4.00, 6.50, 15.00),
  ('CAMINHAO', 'Caminhão', 8.00, 12.00, 50.00)
on conflict ("type") do nothing;

-- 9. Insert Default Users
insert into users ("id", "username", "password", "role", "name", "mustChangePassword")
values 
  ('1', 'admin', 'admin', 'ADMIN', 'Administrador', false),
  ('2', 'operacional', '123', 'OPERATIONAL', 'Operador Logístico', false),
  ('4', 'edna', '123', 'ADMIN', 'Edna (Admin)', true)
on conflict ("id") do nothing;
